---
layout: post
title:  "Тонкий клиент на базе Ubuntu своими руками"
tags: [ubuntu,pxe,thinclient]
---

## История

В далёком 2013 году в банке "Западный" использовались кастомные тонкие клиенты на основе [DisklessUbuntu](https://help.ubuntu.com/community/DisklessUbuntuHowto). С ними были некоторые проблемы, по-моему монтирование корневой ФС по сети в больших филиалах с слабой сетью работало неидеально. Тогда мой хороший друг [@deadroot](https://habrahabr.ru/users/deadroot/) сделал первую версию тонкого клиента, который грузился целиком в память, не требуя что-то монтировать по сети для  работы.

Потом этот клиент активно допиливал я, там было много полезных кастомных штук, специфичных именно для нашего сценария использования. Потом банк ~~развалился~~ закрылся, остатки исходников клиента переехали на мой гитхаб. Пару раз я их слегка допиливал на заказ, как минимум один человек это решение использует.

Недавно у меня дошли руки сделать из этой кучи страшных легко ломающихся скриптов достаточно удобное для использования решение:
* Vagrant поднимает виртуалку, которую можно настраивать настраивать как обычную рабочую станцию.
* Одним скриптом из неё собирается готовые для загрузки по сети файлы, лишнее вырезается.
* Vagrant поднимает виртуальный PXE сервер и сетевой клиент для проверки, что же в итоге получилось собрать.

## Что умеет

* Целиком грузится в память, не требует для работы монтировать корневую ФС по сети.
* Постороена на базе Ubuntu, практически любой софт можно ставить из её богатых репозиториев, ну и подключать сторонние если чего-то не хватило. Особенно приятно, что обновления безопасности прилетают в Ubuntu достаточно быстро.
* Умеет монтировать поверх корневой ФС дополнительные оверлеи. Можно добавить какой-то софт только для некоторых рабочих станций, не собирая новый образ
* Из коробки собирается лёгкий десктоп(LXDE) с RDP-клиентом, адреса и параметры RDP серверов передаются через параметры при загрузке. Можно поменять один параметр и будет собираться минимальная консольная система без лишнего софта - основа для какой-нибудь вашей нестандартной сборки.
* Если загрузка не прошла из-за проблем с сервером или сетью, будет недолго показывать сообщение об ошибке и пытаться загрузится снова.

## Аналоги

Почему бы просто не пользоваться [Thinstation](http://www.thinstation.org/)?

Если Thinstation полностью устраивает - то лучше пользоваться им, это более старый и зрелый проект. Плюс он раза в полтора меньше по размеру, всё-таки это специально заточенная под миниальный объём сборка, а не слегка допиленная обычная Ubuntu.

Но версии софта в нём достаточно древние и его там мало. Если нужно что-то дополнительное, помимо клиентов RDP/Citrix/... - потребутеся собирать это руками, и так при каждом обновлении.

## Vagrant vs chroot

Прошлые версии использовали chroot, как собственно и большинство похожих проектов, тот же Thinstation к примеру. Это несложно, но всё-таки запущеннная в chroot отдельная программа не соответствует реальной картине на реальной машине: нету взаимодействия с системным init, другими программами и службами. Плюс Vagrant позволил сделать процесс создения клиента максимально простым: виртуалка настраивается как обычная машина.

Конечно, использование Vagrant приносит и некоторые сложности.

На машине должна работать служба `virtualbox-guest-utils`, для работы общих папок. Кроме того, нужен менеджер загрузки(`grub`), обязательный для машины с диском и бесполезный для загружаемого по сети клиента. Эти проблемы я решил, исключая из сборки все файлы этих пакетов. Поэтому на размер получившегося образа они не влияют.

Кроме того, для Vagrant обязателен работающий на машине ssh, пускающий пользователя со сгенерированным ключом. Самый неприятный момент. Ключ из собранного образа я для безопасноти исключаю, но если кто-то захочет заходить на тонкие клиенты по ssh, эту часть придётся слегка переделать.

Ну и для работы Vagrant генерирует настройки сетевых интерфейсов, которые будут ошибочными для реальной машины. Пришлось на время сборки подменять файл `interfaces`, и написать скрипт, который на реальной машине генерирует конфиг для настройки всех доступных интерйефсов по DHCP.

Provisioning делается с помощью Ansible. Это очень удобный инструмент для конфигурации всяческого софта и железа. Но включать в итоговый образ Ansible и требующийся ему второй python с нужными билиотеками не хотелось бы: бесплезный балласт. Ставить Ansible на машину, где запукается виртуальное окружение, тоже не хочется: это усложнит работу

Vagrant позволяет сделать хитрость: поставить Ansible на одну машину(тестовый PXE сервер), и с неё делать разворачивание других машин, в той же playbook. Для этого машины должны иметь статический IP, чтобы прописать его в ansible inventory. Ну а проблему с конфигурацией интерфейсов мы решили в прошлом пункте.

## Непослушный кабачок

mksquashfs - костыли для исключений.

Что можно вырезать.

## Магия initrd

initrd - магия, скрипты и хуки.

Оверлеи - магия с mount --move.

Что приходиться монтировать в rw tmpfs.

